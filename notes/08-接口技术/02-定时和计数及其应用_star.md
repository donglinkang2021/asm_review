## 定时和计数及其应用

定时与计数

计数方式

A、方式1-可编程单稳态触发器
B、方式2-脉冲波发生器
C、方式3-方波发生器
D、方式4-软件触发选通方式
E、方式5-硬件触发选通方式

- 软件定时
- 不可编程的硬件定时
- 可编程的定时
- 可编程定时器芯片8254
  - 数据总线缓冲器
  - 读写逻辑
  - 控制字寄存器
  - 计数器

![8254控制字格式](8254控制字格式.png)


<details>
<summary>例8.12 8254地址为40H～43H，编程将计数器0初始化为工作方式3，采用二进制计数模式，计数初值为2000。</summary>

解答：控制口的地址为43H，计数器初值为2000，即07D0H，两个字节，需要采用十六位计数，由上图可知，控制字的格式为00110110B=36H，所以程序为：

```assembly
MOV AL, 36H
OUT 43H, AL     ; 控制字写入控制口
MOV AL, 0D0H    ; 计数器初值低字节
OUT 40H, AL     ; 写入计数器0低字节
MOV AL, 07H     ; 计数器初值高字节
OUT 40H, AL     ; 写入计数器0高字节
```

如果采用BCD计数，2000的BCD为2000H那么程序为：

```assembly
MOV AL, 00110111B
OUT 43H, AL     ; 控制字写入控制口
MOV AL, 00H    ; 计数器初值低字节
OUT 40H, AL     ; 写入计数器0低字节
MOV AL, 20H     ; 计数器初值高字节
OUT 40H, AL     ; 写入计数器0高字节
```

</details>


<details>
<summary>例8.13 假定8254地址为40H～43H，编写程序锁存并读取计数器0的当前计数值。</summary>

控制字地址为43H，读写逻辑地址为40H，计数器0地址为40H，计数器1地址为41H，计数器2地址为42H，控制字为00000110B=06H，所以程序为：

```assembly
MOV AL, 06H
OUT 43H, AL     ; 控制字写入控制口
IN AL, 40H      ; 读取计数器0低字节
MOV AH, AL      ; 保存低字节
IN AL, 40H      ; 读取计数器0高字节
XCHG AL, AH     ; 交换高低字节
```

</details>

### 8254的应用

图8-36；图8-37对应的程序

<table>
<tr>
<td colspan="1">
<details>
<summary>图8-36 8254用于分频</summary>

![8254用于分频](8254用于分频.png)

**分频**：提供一个频率为10kHz的时钟信号，要求每隔100ms采集一次 数 据 。 对 于 一 个 1 0 k H z 时 钟 信 号 ， 其 周 期 为1/10kHz=0.0001s=0.1ms。需要对它进行分频，生成一个周期为100ms的信号，频率为10Hz。计数值1000。

对8253的初始化程序如下：

```assembly
MOV DX, 203H        ; 控制字端口地址
MOV AL, 00110100B   ; D7,D6=00B，选择计数器0；D5,D4=11B，十六位计数；D3~D1=010B，方式2；D0=0B，二进制计数
OUT DX, AL          ; 控制字写入控制字端口
MOV DX, 200H        ; 计数器0端口地址
MOV AL, 0E8H        ; 计数器0初值低字节 1000=03E8H
OUT DX, AL          ; 计数器0初值低字节写入计数器0端口
MOV AL, 03H         ; 计数器0初值高字节
OUT DX, AL          ; 计数器0初值高字节写入计数器0端口
```
</details>    
<td colspan="1">
<details>
<summary>图8-37 8254计数器的级联</summary>

![8254计数器的级联](8254计数器的级联.png)

**级联**：输入脉冲频率为10kHz，要产生周期为100s的定时信号（频率为0.01Hz），那么分频系数N为10k/0.01 =1000000。而计数器的最大计数范围为65536，通过一个计数器不能完成所要求的分频。此时可以将2个计数器进行级联。计数初值应该满足条件：N = N1×N2

这里N1=4000,N2=250，采用方式3，初始化程序如下：

```assembly
MOV DX, 203H        ; 控制字端口地址
MOV AL, 00110111B   ; D7,D6=00B，选择计数器0；D5,D4=11B，十六位计数；D3~D1=011B，方式3；D0=1B，BCD计数
OUT DX, AL          ; 控制字写入控制字端口
MOV AL, 01110111B   ; D7,D6=01B，选择计数器1；
OUT DX, AL          ; 控制字写入控制字端口
MOV DX, 200H        ; 计数器0端口地址
MOV AL, 00H         ; 计数器0初值低字节 4000的BCD为4000H
OUT DX, AL          ; 计数器0初值低字节写入计数器0端口
MOV AL, 40H         ; 计数器0初值高字节
OUT DX, AL          ; 计数器0初值高字节写入计数器0端口
MOV DX, 201H        ; 计数器1端口地址
MOV AL, 50H         ; 计数器1初值低字节 250的BCD为0250H
OUT DX, AL          ; 计数器1初值低字节写入计数器1端口
MOV AL, 02H         ; 计数器1初值高字节
OUT DX, AL          ; 计数器1初值高字节写入计数器1端口
```

</details>    
</td>
</td>
</table>